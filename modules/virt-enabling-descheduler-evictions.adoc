// Module included in the following assemblies:
//
// virt/virtual_machines/advanced_vm_management/virt-enabling-descheduler-evictions.adoc

:_mod-docs-content-type: PROCEDURE
[id="virt-enabling-descheduler-evictions_{context}"]
= Enabling descheduler evictions on a virtual machine (VM)

After the descheduler is installed and configured, all migratable VMs are eligible for eviction by default. You can configure selected VMs to be ignored by the descheduler by adding the opt-out annotation in the `spec.template.metadata.annotations` field of the `VirtualMachine` custom resource (CR).

.Prerequisites

* Install the descheduler in the {product-title} web console or OpenShift CLI (`oc`).

.Procedure

. Stop the VM.

. (Optional) Add the `descheduler.alpha.kubernetes.io/prefer-no-eviction` annotation in the `spec.template.metadata.annotations` field to exclude the VM from eviction. The change is applied dynamically and is propagated to the `VirtualMachineInstance` (VMI) and the `virt-launcher` pod.
+
Only the presence of the annotation is checked. The value is not evaluated, so `"true"` and `"false"` have the same effect.
+
[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
spec:
  template:
    metadata:
      annotations:
        descheduler.alpha.kubernetes.io/prefer-no-eviction: "true"
----

. Configure the `KubeDescheduler` object with the `KubeVirtRelieveAndMigrate` profile and enable background evictions for improved VM eviction stability during live migration:
+
[NOTE]
====
When using the `prefer-no-eviction` annotation to exclude VMs, the `KubeVirtRelieveAndMigrate` profile is sufficient for VM evictions. Do not enable `EvictPodsWithLocalStorage` or `EvictPodsWithPVC`.
====
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: KubeDescheduler
metadata:
  name: cluster
  namespace: openshift-kube-descheduler-operator
spec:
  deschedulingIntervalSeconds: 60
  profiles:
  - KubeVirtRelieveAndMigrate <1>
  mode: Automatic <2>
  profileCustomizations:
    devEnableEvictionsInBackground: true <3>
----
<1> As of {VirtProductName} 4.20, the `KubeVirtRelieveAndMigrate` profile replaces the `DevKubeVirtRelieveAndMigrate` profile.  
<2> By default, the descheduler does not evict pods. To evict pods, set `mode` to `Automatic`.  
<3> Enabling `devEnableEvictionsInBackground` allows evictions to occur in the background, improving stability and mitigating oscillatory behavior during live migrations. You can change this setting at any time.

. Start the VM.

The VM is now configured to be ignored by the descheduler.
